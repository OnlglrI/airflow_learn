# XComs

**XComs** (*сокращение от “cross-communications”*) — это механизм, который позволяет **задачам (Tasks) обмениваться данными между собой**, так как по умолчанию задачи полностью изолированы и могут выполняться даже **на разных машинах**.

---

## Что такое XCom

XCom идентифицируется:

* `key` — ключ (по сути имя значения)
* `task_id` — задача, которая записала значение
* `dag_id` — DAG, к которому относится задача

### Особенности:

* Значение может быть **любым сериализуемым объектом**
* XCom **предназначен только для небольших объёмов данных**
* ❌ **Нельзя использовать для передачи больших данных**, например:

  * DataFrame
  * большие JSON
  * файлы

---

## Push и Pull XCom

XCom’ы **явно записываются и читаются** через методы `xcom_push` и `xcom_pull` объекта `TaskInstance`.

---

### Запись (push) значения в XCom

Чтобы сохранить значение внутри задачи `task-1`, которое будет использовано другой задачей:

```python
# сохраняет any_serializable_value в XCom с ключом "identifier as string"
task_instance.xcom_push(
    key="identifier as string",
    value=any_serializable_value
)
```

---

### Чтение (pull) значения из XCom

Чтобы получить значение, записанное задачей `task-1`, в другой задаче:

```python
# получает XCom с ключом "identifier as string", записанный задачей task-1
task_instance.xcom_pull(
    key="identifier as string",
    task_ids="task-1"
)
```

---

## Автоматический XCom: return_value

Многие операторы автоматически записывают результат выполнения в XCom с ключом **`return_value`**, если аргумент `do_xcom_push=True` (по умолчанию он включён).

То же самое происходит и для функций, объявленных через декоратор `@task`.

---

### Пример неявного использования

Метод `xcom_pull` по умолчанию использует ключ `return_value`, если `key` не указан:

```python
# Получает return_value XCom из задачи "pushing_task"
value = task_instance.xcom_pull(task_ids='pushing_task')
```

---

## Использование XCom в шаблонах (templates)

XCom’ы можно использовать прямо в шаблонах Jinja:

```sql
SELECT * FROM {{ task_instance.xcom_pull(task_ids='foo', key='table_name') }}
```

---

## XComs vs Variables

XCom’ы похожи на **Variables**, но есть ключевые отличия:

| Критерий         | XComs                        | Variables       |
| ---------------- | ---------------------------- | --------------- |
| Область действия | Один task instance           | Глобальные      |
| Время жизни      | Один запуск DAG              | Постоянные      |
| Назначение       | Обмен данными между задачами | Конфигурация    |
| Объём данных     | Очень маленький              | Малый / средний |
| Использование    | Внутри DAG                   | Во всём Airflow |

---

## Важное замечание

> Если первый запуск задачи завершился **неуспешно**, то **при каждом retry все XCom’ы этой задачи будут очищены**.

Это сделано для обеспечения **идемпотентности** повторных запусков задач.