## Обработка файлов DAG

Обработка файлов DAG — это процесс чтения Python-файлов, в которых определены ваши DAG, и сохранения их в таком виде, чтобы планировщик мог запускать эти DAG.

В обработке файлов DAG участвуют два основных компонента:

* **DagFileProcessorManager** — процесс, который выполняется в бесконечном цикле и определяет, какие файлы необходимо обработать;
* **DagFileProcessorProcess** — отдельный процесс, запускаемый для обработки одного файла и преобразования его в один или несколько объектов DAG.

Процесс **DagFileProcessorManager** выполняет пользовательский код. Он запускается как отдельный автономный процесс с помощью CLI-команды:

```
airflow dag-processor
```
![](../../img/dag/dag_proc_scan.png)
Схема обработки файлов DAG показана на иллюстрации:

### Этапы работы DagFileProcessorManager

DagFileProcessorManager выполняет следующие шаги:

1. **Проверка наличия новых файлов**
   Если время, прошедшее с момента последнего обновления DAG, превышает значение `refresh_interval`, обновляется список путей к файлам DAG.

2. **Исключение недавно обработанных файлов**
   Исключаются файлы, которые были обработаны позже, чем `min_file_process_interval`, и с тех пор не изменялись.

3. **Добавление путей к файлам в очередь**
   Найденные файлы добавляются в очередь путей к файлам для последующей обработки.

4. **Обработка файлов**
   Для каждого файла запускается новый процесс `DagFileProcessorProcess`, но не более чем `parsing_processes` одновременно.

5. **Сбор результатов**
   Собираются результаты всех завершившихся процессов обработки DAG.

6. **Логирование статистики**
   Выводится статистика и отправляются метрики, включая `dag_processing.total_parse_time`.

---

### Этапы работы DagFileProcessorProcess

DagFileProcessorProcess выполняет следующие шаги:

1. **Обработка файла**
   Весь процесс обработки должен завершиться в течение тайм-аута `dag_file_processor_timeout`.

2. **Загрузка файлов DAG как Python-модулей**
   Импорт Python-модулей должен завершиться в течение времени ожидания `dagbag_import_timeout`.

3. **Обработка модулей**
   В модуле Python выполняется поиск объектов DAG.

4. **Возврат DagBag**
   Список обнаруженных объектов DAG передаётся обратно в `DagFileProcessorManager`.

---

## Как повысить производительность процессора DAG

Возможные меры:

* Оптимизировать код верхнего уровня DAG и минимизировать его сложность.
* Улучшить использование доступных ресурсов (CPU, память, I/O).
* Увеличить аппаратные ресурсы при наличии узких мест.
* Экспериментировать с параметрами конфигурации процессора DAG.
* При необходимости изменять порядок обработки DAG-файлов.

---

## Параметры конфигурации процессора DAG

Основные параметры:

* **`file_parsing_sort_mode`** — определяет порядок сортировки DAG-файлов перед их разбором.
* **`min_file_process_interval`** — минимальное количество секунд между повторными разборами одного DAG-файла. Меньшее значение увеличивает нагрузку на CPU.
* **`parsing_processes`** — количество параллельных процессов для разбора DAG-файлов.

Дополнительные параметры см. в разделе *Справочник по конфигурации* (`[dag_processor]`).

---

[источник](https://airflow.apache.org/docs/apache-airflow/stable/administration-and-deployment/dagfile-processing.html#fine-tuning-your-dag-processor-performance)